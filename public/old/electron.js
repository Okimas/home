const{app,BrowserWindow,ipcMain,nativeTheme,Tray,dialog,Notification,shell}=require("electron"),Worker=require("worker_threads")["Worker"],path=require("path"),axios=require("axios"),constants=require("./electron/constants"),menu=require("./electron/menu"),logger=require("./electron/logger"),{getValidUniqueFilename,isValidUrl}=require("./electron/utils"),isDev=!1,isMac="darwin"===process.platform,gotTheLock=(process.env.ELECTRON_DISABLE_SECURITY_WARNINGS="true",app.commandLine.appendSwitch("ignore-certificate-errors"),app.requestSingleInstanceLock({myKey:"myValue"}));if(gotTheLock){app.on("second-instance",(e,t,s,n)=>{console.log(n),p&&(p.isMinimized()&&p.restore(),p.focus())}),process.on("uncaughtException",e=>{console.log("Uncaught",e),logger.log("Unkown",e),p&&p.close()});let p,u;const c=e=>{(u=new Tray(isDev?path.resolve(constants.paths.root,"src","assets","images","logo-512x512.png"):path.join(constants.paths.root,"logo.png"))).setToolTip("LyTiX"),u.on("click",()=>{e&&(e.isMinimized()?e.restore():e.isVisible()?e.hide():e.show())})},d=e=>{const t=require("electron-window-state")({defaultWidth:1024,defaultHeight:580});(p=new BrowserWindow({x:t.x,y:t.y,width:t.width,height:t.height,minWidth:960,minHeight:560,show:!1,frame:isMac,webPreferences:{preload:path.join(__dirname,"electron","bridge.js"),webSecurity:!1}})).on("closed",()=>{p=null}),p.once("show",async()=>{}),p.once("ready-to-show",()=>{p.show()}),p.on("maximize",(e,t)=>{p.webContents.send(constants.CHANNELS.WINDOW_IS_MAXIMIZED,!0)}),p.on("unmaximize",(e,t)=>{p.webContents.send(constants.CHANNELS.WINDOW_IS_MAXIMIZED,!1)}),isDev?p.loadURL("http://localhost:3000"):p.loadURL(e),t.manage(p)};app.whenReady().then(async()=>{const n=require("./electron/files"),o=await n.checkFilesAndFolder();let i=await n.loadPrefs();const a=constants.config,r=require("./electron/server");let l=await r.start(i);console.log("SERVER",l);const E=new Worker(isDev?path.join(__dirname,"electron","scanner","scanner.js"):path.join(process.resourcesPath,"scanner","scanner.js"),{workerData:{isDev:isDev}});E.on("message",e=>{"status"in e&&p.webContents.send(constants.CHANNELS.SCANNER_UPDATE,e.status),"dialog"in e&&p.webContents.send(constants.CHANNELS.DIALOG,{title:e.dialog.title,message:e.dialog.message,ok:e.dialog.ok}),"lists"in e&&p.webContents.send(constants.CHANNELS.DATA,e.lists)}),E.on("error",e=>{logger.log("error",e),console.log("error",e),p.webContents.send(constants.CHANNELS.DIALOG,{title:"ERROR",message:e.message,ok:"OK"})}),E.on("exit",e=>{0!==e&&(console.log("exit",e),p.webContents.send(constants.CHANNELS.DATA,constants.listsEmpty),p.webContents.send(constants.CHANNELS.DIALOG,{title:"ERROR",message:"EXIT: "+e,ok:"OK"}))}),ipcMain.on(constants.CHANNELS.WINDOW_CLOSE,()=>{p.close()}),ipcMain.on(constants.CHANNELS.WINDOW_MINIMIZE,()=>{p.minimize()}),ipcMain.on(constants.CHANNELS.WINDOW_MAXIMIZE,()=>{p.isMaximized()?p.restore():p.maximize()}),ipcMain.on(constants.CHANNELS.WINDOW_HIDE,()=>{p.hide()}),ipcMain.on(constants.CHANNELS.FOLDER_SELECT,(e,t)=>{const s=a.texts.global[i.language.replace("-","_")];var n=dialog.showOpenDialogSync(p,{title:s.find(e=>e.code===t.category).value.toUpperCase(),defaultPath:t.defaultPath,properties:["openDirectory"]});p.webContents.send(constants.CHANNELS.FOLDER_SELECT,{category:t.category,index:t.index,folder:n?n[0]:""})}),ipcMain.on(constants.CHANNELS.THEME_SET,async(e,t)=>{var s;if(!await n.setTheme(t))return s=a.texts.system[i.language.replace("-","_")].find(e=>"error-theme-set"===e.code),void new Notification({title:s.title,body:s.message}).show();i.theme=t,nativeTheme.themeSource=t,r.updatePrefs(i),p.webContents.send(constants.CHANNELS.THEME_SET,t)}),ipcMain.on(constants.CHANNELS.LANGUAGE_SET,async(e,t)=>{var s;if(!await n.setLanguage(t))return s=a.texts.system[t.replace("-","_")].find(e=>"error-language-set"===e.code),void new Notification({title:s.title,body:s.message}).show();i.language=t,r.updatePrefs(i),p.webContents.send(constants.CHANNELS.LANGUAGE_SET,t)}),ipcMain.on(constants.CHANNELS.SUBTITLES_SET,async(e,t)=>{var s;if(!await n.setSubtitles(t))return s=a.texts.system[language.replace("-","_")].find(e=>"error-subtitles-set"===e.code),void new Notification({title:s.title,body:s.message}).show();i.subtitles=t,r.updatePrefs(i),p.webContents.send(constants.CHANNELS.SUBTITLES_SET,t)}),ipcMain.on(constants.CHANNELS.PREFS_SET,async(e,t)=>{var s;if("subtitles"in t&&(i.subtitles=t.subtitles,r.updatePrefs(i)),"others"in t&&(i.others=t.others),"remote"in t&&(i.source.remote=t.remote),"folders"in t&&(i.source.local=t.folders),"server"in t&&(l.protocol===t.server.protocol&&l.port===t.server.port||(l=await r.restart(t.server),console.log("SERVER2",l)),i.server=t.server),!await n.savePrefs(i))return s=a.texts.system[i.language.replace("-","_")].find(e=>"error-prefs-set"===e.code),void new Notification({title:s.title,body:s.message}).show();p.webContents.send(constants.CHANNELS.PREFS_SET,i),("remote"in t||"folders"in t||"reset"in t)&&(p.webContents.send(constants.CHANNELS.DATA,null),""===(s=i.source.remote.enabled&&isValidUrl(i.source.remote.url)?i.source.remote.url:"folders"in t?"":l.url)&&p.webContents.send(constants.CHANNELS.SCANNER_UPDATE,constants.scanner),E.postMessage({remote:s,prefs:i,config:a}))}),ipcMain.on(constants.CHANNELS.SERVER_SET,async(e,t)=>{l=r.setEnable(t),p.webContents.send(constants.CHANNELS.SERVER_SET,l)}),ipcMain.on(constants.CHANNELS.CONTROLLER_SET,async(e,t)=>{l=r.setControllerEnable(t),p.webContents.send(constants.CHANNELS.CONTROLLER_SET,l)}),ipcMain.on(constants.CHANNELS.LOAD_PROFILE,async(e,t)=>{const s=(i.source.remote.enabled&&isValidUrl(i.source.remote.url)?i.source.remote:l).url+"/api/profile/"+t[0]+"."+getValidUniqueFilename(...t.slice(1)).replace("#","%23");let n;if(s.startsWith("https://")){t=new require("https").Agent({rejectUnauthorized:!1});try{n=await axios.get(s,{httpsAgent:t})}catch(e){}if(!n||!n.data)try{n=await axios.get(encodeURI(s),{httpsAgent:t})}catch(e){}}else{try{n=await axios.get(s)}catch(e){}if(!n||!n.data)try{n=await axios.get(encodeURI(s))}catch(e){}}n&&"data"in n&&p.webContents.send(constants.CHANNELS.LOAD_PROFILE,n.data)}),ipcMain.on(constants.CHANNELS.PLAY_PROFILE,async(e,t)=>{const s=t.pieces,n=(i.source.remote.enabled&&isValidUrl(i.source.remote.url)?i.source.remote:l).url+"/api/profile/"+s[0]+"."+getValidUniqueFilename(...s.slice(1)).replace("#","%23")+"/medias";let o;if(n.startsWith("https://")){var a=new require("https").Agent({rejectUnauthorized:!1});try{o=await axios.get(n,{httpsAgent:a})}catch(e){}if(!o||!o.data)try{o=await axios.get(encodeURI(n),{httpsAgent:a})}catch(e){}}else{try{o=await axios.get(n)}catch(e){}if(!o||!o.data)try{o=await axios.get(encodeURI(n))}catch(e){}}o&&"data"in o&&p.webContents.send(constants.CHANNELS.PLAY_PROFILE,{storage:s[0]+"."+s[1],medias:o.data,mediaIndex:t.mediaIndex,mediaPlayingId:t.mediaPlayingId})}),ipcMain.on(constants.CHANNELS.OPEN_FILE,async(e,t)=>{var s;i.source.remote.enabled&&isValidUrl(i.source.remote.url)?(s=i.source.remote.url+"/api/file/"+t.replace(/\\/g,"%5C").replace(/\//g,"%5C").replace("#","%23"),shell.openExternal(s)):shell.openPath(t)}),ipcMain.on(constants.CHANNELS.OPEN_LINK,(e,t)=>{shell.openExternal(t)}),ipcMain.on(constants.CHANNELS.INTERFACE_IS_READY,async(e,t)=>{var s;c(p),menu.init(p,u,i.theme,i.language,a.languages,a.texts.system),u.setContextMenu(menu.createMenu()),r.setControllerListener(p.webContents),p.webContents.send(constants.CHANNELS.INIT,{prefs:i,config:a,localServer:l}),o&&null!==l?(p.webContents.send(constants.CHANNELS.DATA,null),s=i.source.remote.enabled&&isValidUrl(i.source.remote.url)?i.source.remote.url:i.others.start?"":l.url,E.postMessage({remote:s,prefs:i,config:a},{eval:!1,workerData:{isDev:isDev}})):(p.webContents.send(constants.CHANNELS.DATA,constants.listsEmpty),s=a.texts.system[i.language.replace("-","_")].find(e=>e.code===(null===l?"error-server-invlaid":"error-filesystem")),p.webContents.send(constants.CHANNELS.DIALOG,{title:s.title,message:s.message,ok:s.buttons[0]}))}),nativeTheme.themeSource=i.theme,d(l.url+"/index.html"),app.on("activate",()=>{0===BrowserWindow.getAllWindows().length&&d(l.url+"/index.html")})}),app.on("window-all-closed",()=>{isMac||app.quit()})}else app.quit();